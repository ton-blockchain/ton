name: Codex auto review

on:
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  issues: write
  pull-requests: write

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # 1) Auto-trigger Codex when PR is opened/reopened/synchronized
  codex-on-pr:
    if: >
      github.event_name == 'pull_request' &&
      (
        github.event.pull_request.user.login == 'EmelyanenkoK' ||
        github.event.pull_request.user.login == 'tolya-yanot' ||
        github.event.pull_request.user.login == 'SpyCheese' ||
        github.event.pull_request.user.login == 'neodix42' ||
        github.event.pull_request.user.login == 'dungeon-master-666' ||
        github.event.pull_request.user.login == 'igroman787' ||
        github.event.pull_request.user.login == 'kdimentionaltree' ||
        github.event.pull_request.user.login == 'sonofmom' ||
        github.event.pull_request.user.login == 'Trinketer22' ||
        github.event.pull_request.user.login == 'xssnick' ||
        github.event.pull_request.user.login == 'tolk-vm' ||
        github.event.pull_request.user.login == 'DanShaders' ||
        github.event.pull_request.user.login == 'birydrad' ||
        github.event.pull_request.user.login == 'abacabadabacaba' ||
        github.event.pull_request.user.login == 'Mustang98' ||
        github.event.pull_request.user.login == 'avevad' ||
        github.event.pull_request.user.login == 'tvorogme' ||
        github.event.pull_request.user.login == 'krigga'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Comment to trigger Codex (on PR event)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "@codex review"
            });

  # 2) Auto-trigger Codex when certain reviewers submit a review
  codex-on-review:
    if: >
      github.event_name == 'pull_request_review' &&
      (
        github.event.review.user.login == 'EmelyanenkoK' ||
        github.event.review.user.login == 'tolya-yanot' ||
        github.event.review.user.login == 'SpyCheese' ||
        github.event.review.user.login == 'neodix42' ||
        github.event.review.user.login == 'dungeon-master-666' ||
        github.event.review.user.login == 'igroman787' ||
        github.event.review.user.login == 'kdimentionaltree' ||
        github.event.review.user.login == 'sonofmom' ||
        github.event.review.user.login == 'Trinketer22' ||
        github.event.review.user.login == 'xssnick' ||
        github.event.review.user.login == 'tolk-vm' ||
        github.event.review.user.login == 'DanShaders' ||
        github.event.review.user.login == 'birydrad' ||
        github.event.review.user.login == 'abacabadabacaba' ||
        github.event.review.user.login == 'Mustang98' ||
        github.event.review.user.login == 'avevad' ||
        github.event.review.user.login == 'tvorogme' ||
        github.event.review.user.login == 'krigga'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Comment to trigger Codex (on review)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewer = context.payload.review.user.login;
            const state = context.payload.review.state; // approved | changes_requested | commented | dismissed
            core.info(`Review by ${reviewer} with state: ${state}`);

            // Optional: restrict to certain review states
            if (state !== 'approved' && state !== 'changes_requested') {
              core.info('Skipping Codex trigger â€“ review state not allowed');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "@codex review"
            });
